## 自动化构建

可以创建 npm scripts 包装构建命令，方便协作

npm scripts 勾子机制：添加前缀`pre`，会自定在对应命令之前执行相应的 scripts

```json
"build": "sass scss/main.scss css/style.css",
"preserve": "yarn build",
"serve":"browser sync ."
```

sass 的 watch 参数会阻塞后续命令，可以通过 npm-run-all 模块同时运行多个命令

## 常用的自动化构建工具

Grunt  
 插件生态强大；  
 基于临时文件目录，每一步都会生成临时文件，处理环节越多，构建速度越慢；

Gulp
基于内存实现；  
 默认支持同时执行多个任务；

FIS
百度出的构建系统；  
 内部处理了多种构建需求，大而全

_Webpack 是一个打包工具，不在构建的讨论范围之内_

## Grunt 的基本使用

1. 添加 grunt 模块

2. 新建 gruntfile.js，这是 grunt 的入口文件，用于定义一些任务；需要导出一个函数，函数会接收一个 grunt 的形参，内部提供一些 api

```javascript
module.export = (grunt) => {
  grunt.regesterTask("foo", () => {
    // 执行任务
  });
  grunt.regesterTask("bar", "任务描述", () => {
    // 执行任务
  });
  // 默认任务，不需要指定任务名称
  // 依次执行foo和bar任务
  grunt.regesterTask("default", ["foo", "bar"]);
  /**
   * 默认都是同步执行任务
   * 异步任务需要使用this，就不能使用箭头函数
   * 使用this.async()创建任务完成标记，在异步任务完成后调用创建的标记函数
   * */
  grunt.regesterTask("async-task", function () {
    const done = this.async();
    setTimeout(() => {
      console.log("async task working...");
      done();
    }, 1000);
  });
};
```

Grunt 标记任务失败

1. 任务中 return false，此任务就失败，后续任务也就不再执行，如果使用--force 执行，就算失败后续任务也会继续执行；异步任务的话给 done 函数传递一个 false 的实参来标记任务失败

Grunt 配置选项方法

```javascript
module.export = (grunt) => {
  grunt.initConfig({
    foo: "bar",
    baz: {
      foz: 123,
    },
  });
  grunt.registerTask("foo", () => {
    console.log(grunt.config("foo"));
    console.log(grunt.config("baz.foz"));
  });
};
```

Grunt 多目标任务

```javascript
module.export = (grunt) => {
  grunt.initConfig({
    build: {
      // options不会作为多任务的目标
      opitons: {
        foo: "bar",
      },
      // 与multiTask任务同名对象
      css: "1", // 属性名就是目标名称
      js: {
        options: {
          // 会覆盖上一级的options
          foo: "baz",
        },
        value: "2",
      },
    },
  });
  grunt.registerMultiTask("build", () => {
    console.log("build task"); // 对多目标运行任务，使用build:css运行指定目标任务
    // 从this身上拿到当前目标和配置信息
    console.log(`target: ${this.target}, data: ${this.data}`); // target: css, data: 1
    console.log(this.options()); // 打印config中的options
  });
};
```

Grunt 插件的使用

```javascript
module.export = (grunt) => {
  grunt.initConfig({
    // 配置clean任务的目标
    clean: {
      temp: "temp/app.js",
    },
  });
  grunt.loadNpmTasks("grunt-contrib-clean"); // 插件命名规范一般为grunt-contrib-任务名，任务名为clean，直接运行的话报No clean targets found，说明这是一个多目标任务
};
```

Grunt 常用插件

- grunt-sass

grunt-sass 需要与 sass 模块同时安装

```javascript
const sass = require("sass");
module.export = (grunt) => {
  grunt.initConfig({
    sass: {
      options: {
        sourceMap: true,
        implementation: sass,
      },
      main: {
        files: {
          "dist/css/main.css": "src/scss/main.scss",
        },
      },
    },
  });
  grunt.loadNpmTasks("grunt-sass");
};
```

- grunt-babel

```javascript
// 通过load-grunt-tasks模块减少grunt.loadNpmTasks的使用
const loadGruntTasks = require("load-grunt-tasks");
const babel = require("@babel/core");
// const preset = require("@babel/preset-env");

module.export = (grunt) => {
  grunt.initConfig({
    sass: {
      options: {
        sourceMap: true,
        implementation: sass,
      },
      main: {
        files: {
          "dist/css/main.css": "src/scss/main.scss",
        },
      },
    },
    babel: {
      options: {
        sourceMap: true,
        presets: ["@babel/preset-env"],
      },
      main: {
        files: {
          "dist/js/app.js": "src/js/app.js",
        },
      },
      watch: {
        js: {
          files: ["src/js/*.js"],
          tasks: ["babel"],
        },
        css: {
          files: ["src/scss/*.scss"],
          tasks: ["sass"],
        },
      },
    },
  });
  loadGruntTask(grunt); // 自动加载所有的grunt插件中的任务
  grunt.registerTask("default", ["sass", "babel", "watch"]); // 保证首次运行watch时sass和babel已经被执行过
};
```

watch 插件：grunt-contrib-watch

## Gulp

gulp 的基本使用

gulpfile.js 入口文件

导出函数成员来定义任务

```javascript
// 导出函数成员来定义gulp任务
exports.foo = (done) => {
  console.log("foo task running");
  done(); // 标识任务结束
};
exports.default = (done) => {
  console.log("default task running");
  done();
};
// gulp 4.0之前注册任务使用gulp.task方法
const gulp = require("gulp");
gulp.task("bar", (done) => {
  console.log("bar running");
  done();
});
```

gulp 默认任务是异步任务
